# Direct Enpack - Архитектура решения

## Общая архитектура

Direct Enpack представляет собой CPG-аддон для CorelDraw, реализованный на языке ассемблера с использованием компилятора FASM. Аддон работает как DLL-библиотека, которая интегрируется в CorelDraw и предоставляет пользовательский интерфейс для компоновки прямоугольных объектов.

## Структура проекта

- `x64/DirectEnpackx64.asm` - основной файл исходного кода на ассемблере
- `x64/CorelDraw.inc` - файл интерфейсов COM-объектов CorelDraw
- `Resources.inc` - файл ресурсов, включая диалоговое окно и строковые константы
- `icon.ico` и `icon.bmp` - иконки для кнопки аддона
- `Readme.md` - документация по установке и использованию
- `LICENSE` - лицензия проекта

## Ключевые компоненты

### 1. Интерфейсные структуры
- `TConfiguration` - структура данных для хранения текущей конфигурации упаковки
- `TCorner` - структура для хранения координат и типа угла
- `TSize` - структура для хранения размеров объекта
- `TCandidate` - структура для хранения кандидатов на размещение

### 2. Основные функции
- `Pack` - основная функция упаковки, которая управляет процессом компоновки
- `PlaceRect` - размещает прямоугольник в списке упакованных объектов
- `FindCandidates` - строит список кандидатов на размещение в каждом вогнутом углу
- `AddCorner` - определяет тип угла (вогнутый/выпуклый) и помещает его в соответствующий список
- `Search` - функция поиска, реализующая многопоточный алгоритм упаковки

### 3. Многопоточность
- Аддон использует многопоточность для ускорения процесса упаковки
- Количество потоков ограничено значением MAX_THREADS (256) и определяется количеством ядер процессора
- Каждый поток работает с собственной копией конфигурации

### 4. Алгоритм упаковки
- Используется модифицированный алгоритм "жадного подхода с перспективной стратегией"
- Алгоритм находит вогнутые углы, где можно разместить прямоугольники
- Для каждого кандидата вычисляется оценочная функция, определяющая наилучший вариант размещения
- Процесс может быть прерван пользователем в любой момент

## Интеграция с CorelDraw

### COM-интерфейсы
- `IVGApplication` - основной интерфейс приложения CorelDraw
- `IVGShape` - интерфейс геометрической формы
- `IVGShapeRange` - интерфейс диапазона форм
- `ICUICommandBars` - интерфейс панелей команд
- `ICUIControl` - интерфейс элементов управления

### Механизм интеграции
- Аддон регистрирует команду плагина через `AddPluginCommand`
- Добавляет кнопку на стандартную панель инструментов
- Использует диалоговое окно для получения параметров от пользователя
- Обрабатывает события через систему событий CorelDraw

## Критические пути реализации

### 1. Инициализация плагина
- `OnLoad` -> `StartSession` -> добавление команды и кнопки

### 2. Процесс упаковки
- Выделение объектов в CorelDraw -> запуск аддона -> диалог параметров -> `Pack` -> размещение объектов -> обновление документа

### 3. Управление памятью
- Выделение памяти для структур данных в функции `Pack`
- Освобождение памяти по завершении процесса упаковки

### 4. Взаимодействие с CorelDraw
- Получение выделенных объектов через `Get_ActiveSelectionRange`
- Изменение позиций объектов через `SetPosition`
- Обновление отображения через `Refresh`

## Зависимости и связи компонентов

- Основной файл `DirectEnpackx64.asm` зависит от `CorelDraw.inc` для интерфейсов COM-объектов
- `Resources.inc` содержит ресурсы, используемые в основном файле
- Используются системные DLL: `KERNEL32.DLL` и `USER32` для работы с потоками, событиями и оконными функциями